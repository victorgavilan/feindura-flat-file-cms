/*
 Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function R(a,e){return{canUndo:true,modes:{wysiwyg:1},exec:function(c){c=c.getSelection();var d=c.getStartElement(),f=c.getRanges()[0],b=K(a,d)||d;if(n(b)){L(a,function(g){b.equals(a.editable)?f.insertNode(g):g[e?"insertAfter":"insertBefore"](b)});a.line.detach()}}}}function S(a,e,c){return n(e)&&n(c)&&c.equals(e.getNext(function(d){return!(A(d)||B(d)||q(d))}))}function w(a){this.upper=a[0];this.lower=a[1];this.set.apply(this,a.slice(2))}function K(a){var e=a.element,c;if(e&&n(e))return(c=
e.getAscendant(a.triggers,true))&&!c.contains(a.editable)&&!c.equals(a.editable)?c:null;return null}function ea(a,e,c){o(a,e);o(a,c);a=e.size.bottom;c=c.size.top;return a&&c?0|(a+c)/2:a||c}function T(a,e,c){return e=e[c?"getPrevious":"getNext"](function(d){return d&&d.type==CKEDITOR.NODE_TEXT&&!A(d)||n(d)&&!q(d)&&!x(a,d)})}function fa(a){var e=a.doc,c=C('<span contenteditable="false" style="'+M+"position:absolute;border-top:1px dashed "+a.boxColor+'"></span>',e);r(c,{attach:function(){this.wrap.getParent()||
this.wrap.appendTo(a.editable,true);return this},lineChildren:[r(C('<span title="'+a.editor.lang.magicline.title+'" contenteditable="false">&#8629;</span>',e),{base:M+"height:17px;width:17px;"+(a.rtl?"right":"left")+":17px;background:url("+this.path+"images/icon.png) center no-repeat "+a.boxColor+";color:transparent;cursor:pointer;"+(s.hc?"font-size: 15px;line-height:14px;border:1px solid #fff;text-align:center;":""),looks:["top:-8px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","2px",1),"top:-17px;"+
CKEDITOR.tools.cssVendorPrefix("border-radius","2px 2px 0px 0px",1),"top:-1px;"+CKEDITOR.tools.cssVendorPrefix("border-radius","0px 0px 2px 2px",1)]}),r(C(U,e),{base:V+"left:0px;border-left-color:"+a.boxColor+";",looks:["border-width:8px 0 8px 8px;top:-8px","border-width:8px 0 0 8px;top:-8px","border-width:0 0 8px 8px;top:0px"]}),r(C(U,e),{base:V+"right:0px;border-right-color:"+a.boxColor+";",looks:["border-width:8px 8px 8px 0;top:-8px","border-width:8px 8px 0 0;top:-8px","border-width:0 8px 8px 0;top:0px"]})],
detach:function(){this.wrap.getParent()&&this.wrap.remove();return this},mouseNear:function(){a.debug.groupStart("mouseNear");o(a,this);var d=a.holdDistance,f=this.size;if(f&&a.mouse.y>f.top-d&&a.mouse.y<f.bottom+d&&a.mouse.x>f.left-d&&a.mouse.x<f.right+d){a.debug.logEnd("Mouse is near.");return true}a.debug.logEnd("Mouse isn't near.");return false},place:function(){var d=a.view,f=a.editable,b=a.trigger,g=b.upper,i=b.lower,j=g||i,k=j.getParent(),h={};this.trigger=b;g&&o(a,g,true);i&&o(a,i,true);o(a,
k,true);a.inInlineMode&&D(a,true);if(k.equals(f)){h.left=d.scroll.x;h.right=-d.scroll.x;h.width=""}else{h.left=j.size.left-j.size.margin.left+d.scroll.x-(a.inInlineMode?d.editable.left+d.editable.border.left:0);h.width=j.size.outerWidth+j.size.margin.left+j.size.margin.right+d.scroll.x;h.right=""}if(g&&i)h.top=g.size.margin.bottom===i.size.margin.top?0|g.size.bottom+g.size.margin.bottom/2:g.size.margin.bottom<i.size.margin.top?g.size.bottom+g.size.margin.bottom:g.size.bottom+g.size.margin.bottom-
i.size.margin.top;else if(g){if(!i)h.top=g.size.bottom+g.size.margin.bottom}else h.top=i.size.top-i.size.margin.top;if(b.is(y)||h.top>d.scroll.y-15&&h.top<d.scroll.y+5){h.top=a.inInlineMode?0:d.scroll.y;this.look(y)}else if(b.is(z)||h.top>d.pane.bottom-5&&h.top<d.pane.bottom+15){h.top=a.inInlineMode?d.editable.height+d.editable.padding.top+d.editable.padding.bottom:d.pane.bottom-1;this.look(z)}else{if(a.inInlineMode)h.top-=d.editable.top+d.editable.border.top;this.look(t)}if(a.inInlineMode){h.top--;
h.top+=d.editable.scroll.top;h.left+=d.editable.scroll.left}for(var l in h)h[l]=CKEDITOR.tools.cssLength(h[l]);this.setStyles(h)},look:function(d){if(this.oldLook!=d){for(var f=this.lineChildren.length,b;f--;)(b=this.lineChildren[f]).setAttribute("style",b.base+b.looks[0|d/2]);this.oldLook=d}},wrap:new N("span",a.doc)});for(e=c.lineChildren.length;e--;)c.lineChildren[e].appendTo(c);c.look(t);c.appendTo(c.wrap);c.unselectable();c.lineChildren[0].on("mouseup",function(d){c.detach();L(a,function(f){var b=
a.line.trigger;f[b.is(E)?"insertBefore":"insertAfter"](b.is(E)?b.lower:b.upper)});a.editor.focus();!s.ie&&a.enterMode!=CKEDITOR.ENTER_BR&&a.hotNode.scrollIntoView();d.data.preventDefault(true)});c.on("mousedown",function(d){d.data.preventDefault(true)});a.line=c}function L(a,e){var c=new CKEDITOR.dom.range(a.doc),d=a.editor,f;if(s.ie&&a.enterMode==CKEDITOR.ENTER_BR)f=a.doc.createText(O);else{f=new N(a.enterBehavior,a.doc);a.enterMode!=CKEDITOR.ENTER_BR&&a.doc.createText(O).appendTo(f)}d.fire("saveSnapshot");
e(f);c.moveToPosition(f,CKEDITOR.POSITION_AFTER_START);d.getSelection().selectRanges([c]);a.hotNode=f;d.fire("saveSnapshot")}function x(a,e){if(!(e&&e.type==CKEDITOR.NODE_ELEMENT&&e.$))return false;var c=a.line;return c.wrap.equals(e)||c.wrap.contains(e)}function n(a){return a&&a.type==CKEDITOR.NODE_ELEMENT&&a.$}function q(a){if(!n(a))return false;var e;if(!(e=W(a)))if(n(a)){e={left:1,right:1,center:1};e=!!(e[a.getComputedStyle("float")]||e[a.getAttribute("align")])}else e=false;return e}function W(a){return!!{absolute:1,
fixed:1,relative:1}[a.getComputedStyle("position")]}function F(a,e){return n(e)?e.is(a.triggers):null}function ga(a,e,c){e=e[c?"getLast":"getFirst"](function(d){return a.isRelevant(d)&&!d.is(ha)});if(!e)return false;o(a,e);return c?e.size.top>a.mouse.y:e.size.bottom<a.mouse.y}function X(a){a.debug.groupStart("triggerEditable");var e=a.editable,c=a.mouse,d=a.view,f=a.triggerOffset;D(a);var b=c.y>(a.inInlineMode?d.editable.top+d.editable.height/2:Math.min(d.editable.height,d.pane.height)/2);e=e[b?"getLast":
"getFirst"](function(g){return!(A(g)||B(g))});if(!e){a.debug.logEnd("ABORT. No edge node found.");return null}if(x(a,e))e=a.line.wrap[b?"getPrevious":"getNext"](function(g){return!(A(g)||B(g))});if(!n(e)||q(e)||!F(a,e)){a.debug.logEnd("ABORT. Invalid edge node.");return null}o(a,e);if(!b&&e.size.top>=0&&c.y>0&&c.y<e.size.top+f){c=a.inInlineMode||d.scroll.y===0?y:t;a.debug.logEnd("SUCCESS. Created box trigger. EDGE_TOP.");return new w([null,e,E,G,c])}else if(b&&e.size.bottom<=d.pane.height&&c.y>e.size.bottom-
f&&c.y<d.pane.height){c=a.inInlineMode||e.size.bottom>d.pane.height-f&&e.size.bottom<d.pane.height?z:t;a.debug.logEnd("SUCCESS. Created box trigger. EDGE_BOTTOM.");return new w([e,null,Y,G,c])}a.debug.logEnd("ABORT. No trigger created.");return null}function Z(a){a.debug.groupStart("triggerEdge");var e=a.mouse,c=a.view,d=a.triggerOffset,f=K(a);a.debug.logElements([f],["Ascendant trigger"],"First stage");if(!f){a.debug.logEnd("ABORT. No element, element is editable or element contains editable.");
return null}o(a,f);d=Math.min(d,0|f.size.outerHeight/2);var b=[],g,i;if(e.y>f.size.top-1&&e.y<f.size.top+d)i=false;else if(e.y>f.size.bottom-d&&e.y<f.size.bottom+1)i=true;else{a.debug.logEnd("ABORT. Not around of any edge.");return null}if(q(f)||ga(a,f,i)||f.getParent().is($)){a.debug.logEnd("ABORT. element is wrong",f);return null}var j=T(a,f,!i);if(j)if(j&&j.type==CKEDITOR.NODE_TEXT){a.debug.logEnd("ABORT. Sibling is non-empty text element");return null}else{if(n(j)){if(q(j)||!F(a,j)||j.getParent().is($)){a.debug.logEnd("ABORT. elementSibling is wrong",
j);return null}b=[j,f][i?"reverse":"concat"]().concat([P,G]);a.debug.log("Configured edge trigger of EDGE_MIDDLE")}}else{if(f.equals(a.editable[i?"getLast":"getFirst"](a.isRelevant))){D(a);if(i&&e.y>f.size.bottom-d&&e.y<c.pane.height&&f.size.bottom>c.pane.height-d&&f.size.bottom<c.pane.height)g=z;else if(e.y>0&&e.y<f.size.top+d)g=y}else g=t;b=[null,f][i?"reverse":"concat"]().concat([i?Y:E,G,g,f.equals(a.editable[i?"getLast":"getFirst"](a.isRelevant))?i?z:y:t]);a.debug.log("Configured edge trigger of "+
(i?"EDGE_BOTTOM":"EDGE_TOP"))}if(0 in b){a.debug.logEnd("SUCCESS. Returning a trigger.");return new w(b)}a.debug.logEnd("ABORT. No trigger generated.");return null}function Q(a,e,c,d){for(var f=function(){var l=s.ie?e.$.currentStyle:a.win.$.getComputedStyle(e.$,"");return s.ie?function(p){return l[CKEDITOR.tools.cssStyleToDomStyle(p)]}:function(p){return l.getPropertyValue(p)}}(),b=e.getDocumentPosition(),g={},i={},j={},k={},h=u.length;h--;){g[u[h]]=parseInt(f("border-"+u[h]+"-width"),10)||0;j[u[h]]=
parseInt(f("padding-"+u[h]),10)||0;i[u[h]]=parseInt(f("margin-"+u[h]),10)||0}if(!c||d)H(a,d);k.top=b.y-(c?0:a.view.scroll.y);k.left=b.x-(c?0:a.view.scroll.x);k.outerWidth=e.$.offsetWidth;k.outerHeight=e.$.offsetHeight;k.height=k.outerHeight-(j.top+j.bottom+g.top+g.bottom);k.width=k.outerWidth-(j.left+j.right+g.left+g.right);k.bottom=k.top+k.outerHeight;k.right=k.left+k.outerWidth;if(a.inInlineMode)k.scroll={top:e.$.scrollTop,left:e.$.scrollLeft};return r({border:g,padding:j,margin:i,ignoreScroll:c},
k,true)}function o(a,e,c){if(!n(e))return e.size=null;if(e.size){if(e.size.ignoreScroll==c&&e.size.date>new Date-aa){a.debug.log("element.size: get from cache");return null}}else e.size={};a.debug.log("element.size: capture");return r(e.size,Q(a,e,c),{date:+new Date},true)}function D(a,e){a.view.editable=Q(a,a.editable,e,true)}function H(a,e){if(!a.view)a.view={};var c=a.view;if(!e&&c&&c.date>new Date-aa)a.debug.log("win.size: get from cache");else{a.debug.log("win.size: capturing");var d=a.win;c=
d.getScrollPosition();d=d.getViewPaneSize();r(a.view,{scroll:{x:c.x,y:c.y,width:a.doc.$.documentElement.scrollWidth-d.width,height:a.doc.$.documentElement.scrollHeight-d.height},pane:{width:d.width,height:d.height,bottom:d.height+c.y},date:+new Date},true)}}function ia(a,e,c,d){for(var f=d,b=d,g=0,i=false,j=false,k=a.view.pane.height,h=a.mouse;h.y+g<k&&h.y-g>0;){i||(i=e(f,d));j||(j=e(b,d));if(!i&&h.y-g>0)f=c(a,{x:h.x,y:h.y-g});if(!j&&h.y+g<k)b=c(a,{x:h.x,y:h.y+g});if(i&&j)break;g+=2}return new w([f,
b,null,null])}CKEDITOR.plugins.add("magicline",{lang:"en,pl",init:function(a){var e={};e[CKEDITOR.ENTER_BR]="br";e[CKEDITOR.ENTER_P]="p";e[CKEDITOR.ENTER_DIV]="div";var c=a.config,d=c.magicline_triggerOffset||30,f=c.enterMode,b={editor:a,enterBehavior:e[f],enterMode:f,triggerOffset:d,holdDistance:0|d*(c.magicline_holdDistance||0.5),boxColor:c.magicline_color||"#ff0000",rtl:c.contentsLangDirection=="rtl",triggers:c.magicline_everywhere?CKEDITOR.dtd.$block:{table:1,hr:1,div:1,ul:1,ol:1,dl:1}},g,i,j,
k;try{b.debug=window.top.DEBUG}catch(h){}b.debug=b.debug||{groupEnd:function(){},groupStart:function(){},log:function(){},logElements:function(){},logElementsEnd:function(){},logEnd:function(){},mousePos:function(){},showHidden:function(){},showTrigger:function(){},startTimer:function(){},stopTimer:function(){}};b.isRelevant=function(l){return n(l)&&!x(b,l)&&!q(l)};a.addCommand("accessSpaceBefore",R(b));a.addCommand("accessSpaceAfter",R(b,true));a.on("contentDom",function(){var l=a.editable(),p=a.document,
I=a.window;r(b,{editable:l,inInlineMode:l.isInline(),doc:p,win:I},true);b.boundary=b.inInlineMode?b.editable:b.doc.getDocumentElement();if(!l.is(CKEDITOR.dtd.$inline)){b.inInlineMode&&!W(l)&&l.setStyles({position:"relative",top:null,left:null});fa.call(this,b);H(b);l.attachListener(a,"beforeUndoImage",function(){b.line.detach()});l.attachListener(a,"beforeGetData",function(){if(b.line.wrap.getParent()){b.line.detach();a.once("getData",function(){b.line.attach()},null,null,1E3)}},null,null,0);l.attachListener(b.inInlineMode?
p:p.getWindow().getFrame(),"mouseout",function(m){if(a.mode=="wysiwyg"){clearTimeout(i);if(b.inInlineMode){m={x:m.data.$.clientX,y:m.data.$.clientY};H(b);D(b,true);var v=b.view.editable,J=b.view.scroll;if(!(m.x>v.left-J.x&&m.x<v.right-J.x)||!(m.y>v.top-J.y&&m.y<v.bottom-J.y)){clearTimeout(k);k=null;b.line.detach()}}else{clearTimeout(k);k=null;i=CKEDITOR.tools.setTimeout(b.line.detach,150,b.line)}}});l.attachListener(l,"keyup",function(){b.hiddenMode=0;b.debug.showHidden(b.hiddenMode)});l.attachListener(l,
"keydown",function(m){if(a.mode=="wysiwyg"){m=m.data.getKeystroke();a.getSelection().getStartElement();switch(m){case 2228240:case 16:b.hiddenMode=1;b.line.detach()}b.debug.showHidden(b.hiddenMode)}});l.attachListener(b.inInlineMode?l:p,"mousemove",function(m){clearTimeout(i);j=true;if(!(a.mode!="wysiwyg"||k)){var v={x:m.data.$.clientX,y:m.data.$.clientY};k=setTimeout(function(){b.debug.groupStart("CheckMouse");b.debug.startTimer();b.mouse=v;k=b.trigger=null;H(b);if(j&&!b.hiddenMode&&a.focusManager.hasFocus&&
!b.line.mouseNear()&&(b.element=ba(b,true))){if(b.trigger=X(b)||Z(b)||ca(b))b.line.attach().place();else{b.trigger=null;b.line.detach()}b.debug.showTrigger(b.trigger);b.debug.mousePos(v.y,b.element);j=false}b.debug.stopTimer();b.debug.groupEnd()},30)}});l.attachListener(I,"scroll",function(){if(a.mode=="wysiwyg"){b.line.detach();if(s.webkit){b.hiddenMode=1;clearTimeout(g);g=setTimeout(function(){b.hiddenMode=0;b.debug.showHidden(b.hiddenMode)},50);b.debug.showHidden(b.hiddenMode)}}});l.attachListener(I,
"mousedown",function(){if(a.mode=="wysiwyg"){b.line.detach();b.hiddenMode=1;b.debug.showHidden(b.hiddenMode)}});l.attachListener(I,"mouseup",function(){b.hiddenMode=0;b.debug.showHidden(b.hiddenMode)});this.backdoor={accessFocusSpace:L,boxTrigger:w,isLine:x,getAscendantTrigger:K,getNonEmptyNeighbour:T,getSize:Q,that:b,triggerEdge:Z,triggerEditable:X,triggerExpand:ca}}},this)}});var E=128,Y=64,P=32,G=16,da=8,y=4,z=2,t=1,O="\u00a0",$=CKEDITOR.dtd.$listItem,ha=CKEDITOR.dtd.$tableContent,aa=100,M="width:0px;height:0px;padding:0px;margin:0px;display:block;z-index:9999;color:#fff;position:absolute;font-size: 0px;line-height:0px;",
V=M+"border-color:transparent;display:block;border-style:solid;",U="<span>"+O+"</span>",r=CKEDITOR.tools.extend,N=CKEDITOR.dom.element,C=N.createFromHtml,s=CKEDITOR.env;w.prototype={set:function(a,e,c){this.properties=a+e+(c||t);return this},is:function(a){return(this.properties&a)==a}};var ba=function(){return function(a,e,c){if(!a.mouse)return null;var d=a.doc,f=a.line.wrap;c=c||a.mouse;var b=new CKEDITOR.dom.element(d.$.elementFromPoint(c.x,c.y));if(e&&x(a,b)){f.hide();b=new CKEDITOR.dom.element(d.$.elementFromPoint(c.x,
c.y));f.show()}if(!(b&&b.type==CKEDITOR.NODE_ELEMENT&&b.$))return null;if(s.ie&&s.version<9)if(!(a.boundary.equals(b)||a.boundary.contains(b)))return null;return b}}(),A=CKEDITOR.dom.walker.whitespaces(),B=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_COMMENT),ca=function(){function a(c){c.debug.groupStart("expandEngine");var d=c.element,f,b,g;if(!n(d)||d.contains(c.editable)){c.debug.logEnd("ABORT. No start element, or start element contains editable.");return null}g=ia(c,function(l,p){return!p.equals(l)},
function(l,p){return ba(l,true,p)},d);f=g.upper;b=g.lower;c.debug.logElements([f,b],["Upper","Lower"],"Pair found");if(S(c,f,b)){c.debug.logEnd("SUCCESS. Expand trigger created.");return g.set(P,da)}c.debug.logElements([d,f,b],["Start","Upper","Lower"],"Post-processing");if(f&&d.contains(f))for(;!f.getParent().equals(d);)f=f.getParent();else f=d.getFirst(function(l){return e(c,l)});if(b&&d.contains(b))for(;!b.getParent().equals(d);)b=b.getParent();else b=d.getLast(function(l){return e(c,l)});if(!f||
!b){c.debug.logEnd("ABORT. There is no upper or no lower element.");return null}o(c,f);o(c,b);if(!(c.mouse.y>f.size.top&&c.mouse.y<b.size.bottom)){c.debug.logEnd("ABORT. Mouse is already above upper or below lower.");return null}d=Number.MAX_VALUE;for(var i,j,k,h;b&&!b.equals(f);){if(!(j=f.getNext(c.isRelevant)))break;i=Math.abs(ea(c,f,j)-c.mouse.y);if(i<d){d=i;k=f;h=j}f=j;o(c,f)}c.debug.logElements([k,h],["Min","MinNext"],"Post-processing results");if(!k||!h){c.debug.logEnd("ABORT. No Min or MinNext");
return null}if(!(c.mouse.y>k.size.top&&c.mouse.y<h.size.bottom)){c.debug.logEnd("ABORT. Mouse is already above minElement or below minElementNext.");return null}g.upper=k;g.lower=h;c.debug.logEnd("SUCCESSFUL post-processing. Trigger created.");return g.set(P,da)}function e(c,d){return!(d&&d.type==CKEDITOR.NODE_TEXT||B(d)||q(d)||x(c,d)||d.type==CKEDITOR.NODE_ELEMENT&&d.$&&d.is("br"))}return function(c){c.debug.groupStart("triggerExpand");var d=a(c);c.debug.groupEnd();var f;if(f=d){c.debug.groupStart("expandFilter");
f=d.upper;var b=d.lower;if(!f||!b||q(b)||q(f)||b.equals(f)||f.equals(b)||b.contains(f)||f.contains(b)){c.debug.logEnd("REJECTED. No upper or no lower or they contain each other.");f=false}else if(F(c,f)&&F(c,b)&&S(c,f,b)){c.debug.logElementsEnd([f,b],["upper","lower"],"APPROVED EDGE_MIDDLE");f=true}else{c.debug.logElementsEnd([f,b],["upper","lower"],"Rejected unknown pair");f=false}}return f?d:null}}(),u=["top","left","right","bottom"]})();
